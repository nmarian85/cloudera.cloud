install_cdp_dlake:
  stage: install_cdp_dlake
  before_script:
    - cdp datalake create-aws-datalake --generate-cli-skeleton > skel.json
    - OUT=$(python3 scripts/dump_dlake_json.py --action install --env $ENV --cdp-env-name $CDP_ENV_NAME)
    - export DLAKE_NAME=$(echo $OUT | awk -F, '{print $1}')
    - export RANGER_ROLE=$(echo $OUT | awk -F, '{print $2}')
    - export DATA_ROLE=$(echo $OUT | awk -F, '{print $3}')
  script:
    - cat *.json
    - cdp environments set-id-broker-mappings --set-empty-mappings --environment-name $CDP_ENV_NAME --data-access-role $DATA_ROLE --ranger-audit-role $RANGER_ROLE
    - cdp --debug datalake create-aws-datalake --cli-input-json file://${DLAKE_NAME}.json || true
    - timeout 60m bash scripts/wait_for_status.sh "DL" "RUNNING"
  artifacts:
    paths:
      - "*.json"
    expire_in: 30 days
    when: always
  rules:
    - if: $ACTION == "install"