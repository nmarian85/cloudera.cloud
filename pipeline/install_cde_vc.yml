install_cde_vc:
  stage: install_cde_vc
  before_script:
    - cdp de create-vc --generate-cli-skeleton > skel.json
    - cdp de list-services > services.json
  script:
    - > 
      for CDE_CLUSTER_NAME in $CDE_CLUSTERS; do
        export CDE_CLUSTER_NAME=$CDE_CLUSTER_NAME
        python3 scripts/get_cde_cluster_id.py
    - >
      for CDE_CLUSTER_NAME in $CDE_CLUSTERS; do
        export CDE_CLUSTER_NAME=$CDE_CLUSTER_NAME

            for service in services["services"]:
        if service["name"] == cde_cluster_name:
            return service["clusterId"]
        CLUSTER_ID=$(python3 scripts/get_cde_cluster_id.py)

        python3 scripts/dump_cde_vc_json.py --action install
    - cat *.json
    - ls -1 *_vc.json | xargs -I '{}' cdp --debug de create-vc --cli-input-json file://'{}' || true
    # - >
    #   for CDE_CLUSTER_NAME in $CDE_CLUSTERS; do
    #     export CDE_CLUSTER_NAME=$CDE_CLUSTER_NAME
    #     timeout 90m bash scripts/wait_for_status.sh "CDE" "ClusterCreationCompleted"
    #   done
  artifacts:
    paths:
      - "*.json"
    expire_in: 30 days
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE != "schedule" && $ACTION == "install_cde_vc"
      # when: manual
