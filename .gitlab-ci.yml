---
variables:
  DOCKER_IMAGE_VERSION: "1.0"
  DOCKER_IMAGE_NAME: cdpcli-ddp
  DOCKER_IMAGE_URL: $DOCKER_REGISTRY/$ARTIFACTORY_REPOSITORY_NAME/$DOCKER_IMAGE_NAME:$DOCKER_IMAGE_VERSION
# install (installs a CDP environment and its attached datalake)
# delete (deletes a CDP environment and its attached datalake)
# start (starts a CDP environment and its attached datalake)
# stop (stops environment and its attached datalake)
# install_cml (installs CML cluster)
# delete_cml (deletes a CML cluster)
# install_cde (installs a CDE cluster)
# delete_cde (deletes a CDE cluster)
  ACTION: install_cde
  CDP_ENV_NAME: devo-cdp-lab-env01
  ENV: lab
  CML_CLUSTERS: "devo-cdp-lab-env01-cml02" # space delimited as per Gitlab variable limitation

image: ${DOCKER_IMAGE_URL}

default:
  tags:
    - docker

stages:
  - install_cdp_env
  - install_cdp_dlake
  - delete_cdp_dlake
  - delete_cdp_env
  - start
  - stop
  - install_cml
  - delete_cml
  - install_cde

include:
  - 'pipeline/install_cdp_env.yml'
  - 'pipeline/install_cdp_dlake.yml'
  - 'pipeline/delete_cdp_dlake.yml'
  - 'pipeline/delete_cdp_env.yml'
  - 'pipeline/start_cdp_env.yml'
  - 'pipeline/stop_cdp_env.yml'
  - 'pipeline/install_cml.yml'
  - 'pipeline/delete_cml.yml'
  - 'pipeline/install_cde.yml'
  # - 'pipeline/delete_cde.yml'

  #TODO: Add 'grant access to admin/jumpserver role AWS IAM role EKS cluster control plane'



# cde_delete:
#   stage: delete
#   before_script:
#     - cdp de disable-service --generate-cli-skeleton > skel.json
#   script:
#     - >
#       for CDE_CLUSTER_NAME in $CDE_CLUSTERS; do
#         export CDE_CLUSTER_NAME=$CDE_CLUSTER_NAME
#         timeout 90m bash wait_for_del.sh "CDE"
#       done
#   artifacts:
#     paths:
#       - "*.json"
#     expire_in: 30 days
#     when: always
#   rules:
#     - if: $CI_PIPELINE_SOURCE != "schedule" && $ACTION == "delete"
#       when: manual

# cde_provision_vc:
#   stage: provision
#   tags:
#     - docker
#   script:
#     - cdp de create-vc --generate-cli-skeleton > vc_skel.json
#     - cat vc_skel.json | python3 vc_cde_json_create.py > vc_env.json
#     - cat vc_env.json
#     - cdp --debug de create-vc --cli-input-json file://vc_env.json
#   artifacts:
#     paths:
#       - "*.json"
#     expire_in: 30 days
#     when: always
#   rules:
#     - if: $CI_PIPELINE_SOURCE != "schedule" && $ACTION == "delete"
#       when: manual


