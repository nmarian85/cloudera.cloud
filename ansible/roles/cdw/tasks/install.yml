- name: Retrieve cluster id for CDW cluster
  cloudera.cloud.dw_cluster_info:
    env: "{{ env_name }}"
  register: cdw_cluster_info

- name: Enable the Cloudwatch logging for EKS
  shell: 'aws eks update-cluster-config --name {{ cdw_cluster_info[''clusters''][0][''id''] }}-dwx-stack-eks --logging ''{"clusterLogging": [{"types": ["api","audit","authenticator","controllerManager","scheduler"],"enabled": true}]}'''
  register: eks_out
  failed_when:
    - eks_out.rc != 0
    - '"No changes needed for the logging config provided" not in eks_out.stderr'

- include_role:
    name: cdw_vw
  vars:
    cdw_vw: "{{ cdw_vw_info.value }}"
    cdw_vw_name: "{{ cdw_vw_info.key }}"
    cdw_cluster_info: "{{ cdw_cluster_info }}" # TODO: threw an error so var name might need to be changed
  with_dict: "{{ cdw_vws }}"
  loop_control:
    loop_var: cdw_vw_info
